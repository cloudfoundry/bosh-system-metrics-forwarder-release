#!/bin/bash

RUN_DIR=/var/vcap/sys/run/indicator-registration-agent
LOG_DIR=/var/vcap/sys/log/indicator-registration-agent
PIDFILE=$RUN_DIR/indicator-registration-agent.pid
JOB_DIR=/var/vcap/jobs/indicator-registration-agent
INDICATOR_DOCUMENT=$JOB_DIR/config/indicators.yml

PACKAGE_DIR=/var/vcap/packages/indicator-registration-agent

case $1 in

start)
mkdir -p $RUN_DIR $LOG_DIR
chown -R vcap:vcap $RUN_DIR $LOG_DIR

cd $PACKAGE_DIR

ulimit -n 8192

echo $$ > $PIDFILE
exec chpst -u vcap:vcap ./registration_agent \
  --indicators-path="$INDICATOR_DOCUMENT" \
  --registry="<%= p('indicators.registry_uri') %>" \
  --deployment="<%= p('deployment_name') %>" \
  --interval="<%= p('indicators.interval') %>" \
  &>> ${LOG_DIR}/indicator-registration-agent.log

;;

stop)

kill `cat $PIDFILE`

rm -f $PIDFILE

;;

*)
echo "Usage: ctl {start|stop}" ;;

esac
